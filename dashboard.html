<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- Elegant Font -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(to bottom right, #f4f8ff, #e6f0ff);
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
    }

    .brand-title {
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      letter-spacing: 1px;
      color: #2c3e50;
    }

    .header-bar {
      background: #ffffff;
      border-radius: 12px;
    }

    .post-card {
      background-color: #eaf4ff;
      border-radius: 16px;
      transition: 0.3s ease;
      position: relative;
    }

    .post-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.12);
    }

    .btn-theme {
      background-color: #4a90e2;
      border: none;
      color: white;
    }

    .btn-theme:hover {
      background-color: #3a7bd5;
    }

    .reaction-btn {
      border-radius: 20px;
    }
  </style>
</head>

<body>

<div class="container py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4 p-3 shadow-sm header-bar">

    <h3 class="m-0 brand-title">Emotion Community</h3>

    <div>
      <a href="post.html" class="btn btn-theme btn-sm">+ Post</a>
      <a href="profile.html" class="btn btn-outline-primary btn-sm ms-2">Profile</a>
      <a href="notifications.html" class="btn btn-outline-secondary btn-sm ms-2">
        üîî <span id="notifCount" class="badge bg-dark">0</span>
      </a>
    </div>

  </div>

  <!-- Posts -->
  <div id="feed"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { 
  getFirestore, collection, addDoc, getDocs, query, orderBy,
  deleteDoc, doc, updateDoc, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDbJ2WrjZD5KpYirppactc1eOFNnsdG5Dg",
  authDomain: "emotion-community-app.firebaseapp.com",
  projectId: "emotion-community-app",
  storageBucket: "emotion-community-app.firebasestorage.app",
  messagingSenderId: "684942590421",
  appId: "1:684942590421:web:0e4dd3b50450f19ee4fd5c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ------------------ Notification Count ------------------ */

async function loadNotificationCount() {
  const snapshot = await getDocs(collection(db, "notifications"));
  let count = 0;

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    if (data.userId === auth.currentUser.uid && data.read === false) {
      count++;
    }
  });

  document.getElementById("notifCount").innerText = count;
}

/* ------------------ Posts ------------------ */

async function loadPosts() {
  const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
  const snapshot = await getDocs(q);
  const feed = document.getElementById("feed");
  feed.innerHTML = "";

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const postId = docSnap.id;

    const timestamp = data.createdAt?.toDate();
    const formattedDate = timestamp ? timestamp.toLocaleString() : "Just now";

    feed.innerHTML += `
      <div class="card post-card p-4 mb-4 shadow-sm border-0">

        <!-- 3 Dot Menu -->
        <div class="dropdown position-absolute top-0 end-0 m-2">
          <button class="btn btn-sm" data-bs-toggle="dropdown">
            <i class="bi bi-three-dots-vertical"></i>
          </button>

          <ul class="dropdown-menu dropdown-menu-end">
            ${
              auth.currentUser.uid === data.userId
              ? `
                <li><a class="dropdown-item" href="#" onclick="editPost('${postId}', \`${data.text}\`)">Edit</a></li>
                <li><a class="dropdown-item text-danger" href="#" onclick="deletePost('${postId}')">Delete</a></li>
              `
              : `
                <li><a class="dropdown-item text-warning" href="#" onclick="reportPost('${postId}')">Report</a></li>
              `
            }
          </ul>
        </div>

        <p class="mb-2">${data.text}</p>

        <small class="text-muted">
          ${data.emotion} | ${data.category}
        </small><br>

        <small class="text-secondary">
          Posted on: ${formattedDate}
        </small>

        <!-- Reactions -->
        <div class="mt-3">
          <button class="btn btn-outline-primary btn-sm reaction-btn"
            onclick="react('${postId}','likes')">
            üëç ${data.likes || 0}
          </button>

          <button class="btn btn-outline-danger btn-sm ms-2 reaction-btn"
            onclick="react('${postId}','love')">
            ‚ù§Ô∏è ${data.love || 0}
          </button>

          <button class="btn btn-outline-secondary btn-sm ms-2 reaction-btn"
            onclick="react('${postId}','sad')">
            üò¢ ${data.sad || 0}
          </button>
        </div>

      </div>
    `;
  });
}

/* ------------------ Reactions ------------------ */

window.react = async function(postId, type) {

  const userId = auth.currentUser.uid;
  const reactionRef = doc(db, "posts", postId, "reactions", userId);
  const postRef = doc(db, "posts", postId);

  const reactionSnap = await getDoc(reactionRef);
  const postSnap = await getDoc(postRef);
  const postData = postSnap.data();

  if (reactionSnap.exists()) {

    const oldReaction = reactionSnap.data().type;

    if (oldReaction === type) {
      alert("You already reacted with this.");
      return;
    }

    await updateDoc(postRef, {
      [oldReaction]: (postData[oldReaction] || 1) - 1
    });
  }

  await updateDoc(postRef, {
    [type]: (postData[type] || 0) + 1
  });

  await setDoc(reactionRef, { type });

  loadPosts();
};

/* ------------------ Edit/Delete/Report ------------------ */

window.deletePost = async function(postId) {
  await deleteDoc(doc(db, "posts", postId));
  loadPosts();
};

window.editPost = async function(postId, oldText) {
  const newText = prompt("Edit your post:", oldText);
  if (!newText) return;

  await updateDoc(doc(db, "posts", postId), {
    text: newText
  });

  loadPosts();
};

window.reportPost = async function(postId) {
  alert("Reported");
};

/* ------------------ Auth State ------------------ */

onAuthStateChanged(auth, (user) => {
  if (user) {
    loadPosts();
    loadNotificationCount();
  } else {
    window.location.href = "login.html";
  }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>